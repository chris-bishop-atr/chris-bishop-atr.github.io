# Author: Chris Bishop
# Created: 05Dec2021
# Purpose: Automated CI / CD Pipeline to Build, Scan (TODO), 
#     and Publish Jekyll Assets from main branch to gh-pages branch
# See: https://github.com/marketplace/actions/jekyll-actions

name: jekyll-ci-build-and-publish-workflow

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    
      # Checks-out your repository/branch under $GITHUB_WORKSPACE, so your job can access it
      # See: https://github.com/marketplace/actions/checkout
      - uses: actions/checkout@v2
      
      # Use GitHub Actions' cache to shorten build times and decrease load on servers
      # See: https://github.com/marketplace/actions/cache
      - uses: actions/cache@v2
        with:
          path: vendor/bundle
          key: ${{ runner.os }}-gems-${{ hashFiles('**/Gemfile') }}
          restore-keys: |
            ${{ runner.os }}-gems-
            
      # Use the 3rd Party Jekyll Managed jekyll-action to build Jekyll sources checked out from main
      #     then publish resulting SSG outfiles to the gh-pages branch which should trigger a new env
      #     deployment to https://chris-bishop.github.io/
      # See: https://github.com/marketplace/actions/jekyll-actions
      - uses: helaili/jekyll-action@v2
        with:
          # NOTE - secrets.GITHUB_TOKEN is like an AWS Default KMS Key managed by Github, NOT a user managed PAT!
          token: ${{ secrets.GITHUB_TOKEN }}
          # Where the build job should look for source files and templates. Defaults to repo root. 
          # Set the jekyll_src value to a subdirectory below, as desired
          jekyll_src: ''
          # Branch to publish the resulting SSG output files to.
          target_branch: 'gh-pages'
